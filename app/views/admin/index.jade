extends ../layout

block append js
  script(src="/socket.io/socket.io.js")

  script.
    function updateCounter() {
      $('#counter').text($('#users li.active').length);
    }

    $(function() {
      io = io.connect();

      // Listen for user.connect event.
      io.on('user.connect', function(user) {
        $user = $("#users").find('[data-user-code="' + user.code + '"]');
        if (!$user.length) {
          $user = $('<li/>').attr('data-user-code', user.code).text(user.display_name);
        }
        $user.attr('class', 'active');
        $user.prependTo('#users');
        updateCounter();
      });

      // Listen for user.disconnect event.
      io.on('user.disconnect', function(user) {
        $user = $("#users").find('[data-user-code="' + user.code + '"]');
        $user.attr('class', 'inactive');
        $user.appendTo('#users');
        updateCounter();
      });

      // Listen for user.log event.
      io.on('user.log', function(users) {
        $.each(users, function() {
          $user = $('<li/>').attr('data-user-code', this.code).text(this.display_name);
          if (this.active_flag) {
            $user.attr('class', 'active');
            $user.prependTo('#users');
          } else {
            $user.attr('class', 'inactive');
            $user.appendTo('#users');
          }

          // for admin
          $show_field = $('<dl/>').addClass('show_field');
          $user_code = $('<dt/>').addClass('code').text(this.code);
          $user_code.appendTo($show_field);
          $user_sep = $('<dd/>').addClass('sep').text('@');
          $user_sep.appendTo($show_field);
          $user_name = $('<dd/>').addClass('name').text(this.name || 'Anonymous');
          $user_name.appendTo($show_field);

          $user_map = $('<div/>').attr('data-user-code', this.code).addClass('user_map');
          $user_map.append($show_field);
          $user_map.appendTo('#users_map');
        });
        updateCounter();
      });

      // from http://stackoverflow.com/questions/14645806/get-all-attributes-of-an-element-using-jquery
      (function(old) {
        $.fn.attr = function() {
          if(arguments.length === 0) {
            if(this.length === 0) {
              return null;
            }

            var obj = {};
            $.each(this[0].attributes, function() {
              if(this.specified) {
                obj[this.name] = this.value;
              }
            });
            return obj;
          }

          return old.apply(this, arguments);
        };
      })($.fn.attr);

      function inputStart(element) {
        $element = $(element);
        $input = $('<input/>').attr($element.attr());
        $input.insertAfter($element);
        $input.focus();
        $input.val($element.text());
        $element.addClass('hidden');

        var ime = new LibIME($input);
        ime.onkeyup = function(args) {
          event = args[0];
          switch (ime.status) {
          case 2:
            if (event.keyCode !== 13) return;
            inputComplete($input);
          }
        }
      }

      function inputComplete(input) {
        $input = $(input);
        $element = $input.closest('.show_field').find('.hidden');
        $element.text($input.val());
        $element.removeClass('hidden');
        $input.remove();
      }

      $(document).on('click', '.show_field :not(input).code, .show_field :not(input).name', function() {
        inputStart(this);
      });

      $(document).on('blur', '.show_field input.code, .show_field input.name', function() {
        inputComplete(this);
      });
    });


block content
  #nav
    #counter
    ul#users
  #contents
    form
      input.code(placeholder="IP Address")
      .sep @
      input.name(placeholder="User name")
    #users_map
