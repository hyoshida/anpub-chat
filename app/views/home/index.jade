extends ../layout

block append js
  script(src="/socket.io/socket.io.js")

  script.
    function imageify($target) {
      $target.find('a').each(function() {
        url = $(this).text();
        if (!url.match(/\.(jpg|jpeg|gif|png)$/)) return;

        $image = $('<img/>')
          .attr('src', url)
          .css({ 'max-width': 320 });
        $(this).html($image);
      });
    }

    function youtubeify($target) {
      $target.find('a').html(function(_, html) {
        var pattern  = /(?:http:\/\/)?(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=)?(.+)/g;
        var video = '<iframe width="320" height="240" src="http://www.youtube.com/embed/$1" frameborder="0" allowfullscreen></iframe>';
        return html.replace(pattern, video);
      });
    }

    $(function() {
      io = io.connect();

      // Listen for talk event.
      io.on('talk', function(data) {
        $('#messages').prepend('<strong>@' + data.user_name + ': </strong>' + data.message + '<br>');
        $('#messages').linkify();
        imageify($('#messages'));
        youtubeify($('#messages'));
      });

      // Listen for talk.log event.
      io.on('talk.log', function(data) {
        $.each(data, function() {
          $('#messages').prepend('<strong>@' + this.user_name + ': </strong>' + this.message + '<br>');
        });
        $('#messages').linkify();
        imageify($('#messages'));
        youtubeify($('#messages'));
      });

      // Emit talk event.
      $('form').submit(function(event) {
        // stop form from submitting normally
        event.preventDefault();

        message = $('input').val();
        io.emit('talk', message);
        $('input').val('');
      });
    });

block content
  form
    input
  #messages
